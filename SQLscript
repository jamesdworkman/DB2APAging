WITH APcte AS (SELECT 'Moseley' AS "Company", amflib1.OPNPAY01.COMNO,amflib1.VENNAM.VNAME, amflib1.OPNPAY01.VNDNR,amflib1.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amflib1.VENNAM.VNAMA
FROM amflib1.OPNPAY01
JOIN amflib1.VENNAM ON amflib1.OPNPAY01.vndnr=amflib1.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101
UNION 
SELECT 'Axxcss' AS "Company",amflib4.OPNPAY01.COMNO,amflib4.VENNAM.VNAME, amflib4.OPNPAY01.VNDNR,amflib4.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amflib4.VENNAM.VNAMA
FROM amflib4.OPNPAY01
JOIN amflib4.VENNAM ON amflib4.OPNPAY01.vndnr=amflib4.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101
UNION 
SELECT 'CarrierComm' AS "Company",amflib5.OPNPAY01.COMNO,amflib5.VENNAM.VNAME, amflib5.OPNPAY01.VNDNR,amflib5.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amflib5.VENNAM.VNAMA
FROM amflib5.OPNPAY01
JOIN amflib5.VENNAM ON amflib5.OPNPAY01.vndnr=amflib5.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101
UNION 
SELECT 'E-Band' AS "Company",amfliba.OPNPAY01.COMNO,amfliba.VENNAM.VNAME, amfliba.OPNPAY01.VNDNR,amfliba.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amfliba.VENNAM.VNAMA
FROM amfliba.OPNPAY01
JOIN amfliba.VENNAM ON amfliba.OPNPAY01.vndnr=amfliba.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101
UNION 
SELECT 'Remec' AS "Company",amflibb.OPNPAY01.COMNO,amflibb.VENNAM.VNAME, amflibb.OPNPAY01.VNDNR,amflibb.OPNPAY01.INVNO,
CASE WHEN TDRCR ='D' THEN -1*GRAMT 
ELSE GRAMT 
END AS NormalizedAmount,PPATD,date(TIMESTAMP( (DUEDT + 19000000) CONCAT'000000')) AS "DueDate", amflibb.VENNAM.VNAMA
FROM amflibb.OPNPAY01
JOIN amflibb.VENNAM ON amflibb.OPNPAY01.vndnr=amflibb.VENNAM.VNDNR 
WHERE gramt-PPATD > 0 AND INVDT > 1150101)
SELECT "Company",VNAME AS "Vendor Name",VNAMA AS "Vendor Abbreviation", 
sum(CASE WHEN date(CURRENT date)-"DueDate" < -7 THEN NormalizedAmount-PPATD
ELSE NULL
END) AS "Not Due",
sum(CASE WHEN date(CURRENT date)-"DueDate" BETWEEN -7 AND 0 THEN NormalizedAmount-PPATD
ELSE NULL
END) AS "Due This Week",
sum(CASE WHEN date(CURRENT date)-"DueDate" BETWEEN 1 AND 7 THEN NormalizedAmount-PPATD
ELSE NULL
END) AS "1-7 Days Past Due",
sum(CASE WHEN date(CURRENT date)-"DueDate" BETWEEN 8 AND 14 THEN NormalizedAmount-PPATD
ELSE NULL
END) AS "8-14 Days Past Due",
sum(CASE WHEN date(CURRENT date)-"DueDate" BETWEEN 15 AND 21 THEN NormalizedAmount-PPATD
ELSE NULL
END) AS "15-21 Days Past Due",
sum(CASE WHEN date(CURRENT date)-"DueDate" > 21 THEN NormalizedAmount-PPATD
ELSE NULL
END) AS "3+ Weeks Past Due",
sum(NormalizedAmount-PPATD) AS Total
FROM APcte
GROUP BY "Company",VNAME,VNAMA
ORDER BY  "Company", sum(NormalizedAmount-PPATD) desc
